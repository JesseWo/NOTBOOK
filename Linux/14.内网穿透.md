# 内网穿透 
## [frp](https://github.com/fatedier/frp/blob/master/README_zh.md)
github 文档很详尽

## [nps](https://github.com/cnlh/nps)

## ZeroTier (✨)
- [官网](https://www.zerotier.com/)
- [wiki](https://zerotier.atlassian.net/wiki/spaces/SD/overview)
- [github](https://github.com/zerotier/ZeroTierOne)
- [开放api](https://my.zerotier.com/help/api)
> 强烈推荐! 不同于其他内网穿透的方式, zeroTier采用 p2p 方式组建虚拟局域网, 每个加入此局域网中的设备都会分配一个局域网IP. 基于此, 很多只能在局域网中使用的软件或者服务都能通过 ZeroTier 实现远程访问, 比如 smb, vnc, TimeMachine. 加入局域网需要三个条件, 1. 安装zeroTier client; 2. 获取此虚拟局域网的 networkId; 3. 此虚拟局域网的创建者(管理员)同意加入, 并分配IP. 所以这种方式并不是像反向代理一样直接将内网服务暴露在公网上, 最大限度保证了安全.

### 3.1 安装
#### mac
有以下两种安装方式, 
 - 方式一直接下载官网提供的 pkg 安装; 
 - 方式二使用homebrew; 

建议使用 [方法二], 一是方便快捷, 二是装完后使用 `zerotier-cli` 命令行不用 `sudo`

```
# 安装
brew cask install zerotier-one

# 使用: 用 launchd 管理
sudo launchctl load /Library/LaunchDaemons/com.zerotier.one.plist
sudo launchctl unload /Library/LaunchDaemons/com.zerotier.one.plist

```
#### linux
```
# 安装
curl -s https://install.zerotier.com/ | sudo bash

# 如果以上命令因网络原因下载失败, 建议配置使用 proxychains 代理
curl -s https://install.zerotier.com/ | sudo proxychains bash

# 使用: 用 systemd 管理
systemctl start zerotier-one
systemctl stop zerotier-one
systemctl restart zerotier-one
systemctl status zerotier-one
```

### 3.2 使用
整体采用CS架构, `/usr/sbin/zerotier-one` 作为 daemon 是核心 service, 并对外开放 json api, `/usr/sbin/zerotier-cli` 是client 的默认实现; cli 具体使用:
```
zerotier-cli -h
```

### 3.3 添加moon节点
moon节点是用来加速的, 建议用国内的云服务器作为moon, 有两个坑要注意:
- 以阿里云为例, 记得配置安全组规则, 开放 9993 端口(zerotier 的默认端口)的 udp 和 tcp 入口访问权限;
- 作为moon节点的服务器不要 join 任何网络(官方建议), 就让他静静的作为 moon 好了;

### 3.4 Controller
[Network Controller Microservice](https://github.com/zerotier/ZeroTierOne/tree/master/controller)
>ZeroTier network controllers can easily be run in Docker or other container systems. Since containers do not need to actually join networks, extra privilege options like "--device=/dev/net/tun --privileged" are not needed. You'll just need to map the local JSON API port of the running controller and allow it to access the Internet (over UDP/9993 at a minimum) so things can reach and query it.

WebUI: ztnui
- [官网](https://key-networks.com/ztncui/)
- [github-docker](https://github.com/key-networks/ztncui-containerized)

> zerotier-one 各个终端本身都已默认集成了 controller (用来创建/管理 network, 给 peers 分配ip等, 有点类似于路由器的角色), 并对外开放了 api. ztnui 只是个 webUI (类似路由器的Luci), 通过 json api 调用 Controller, 所以非必须, 完全可以直接用官方提供的controller默认实现: https://my.zerotier.com

docker-compose.yml
```
version: '2'
services:
  ztncui:
    image: keynetworks/ztncui
    restart: always
    container_name: ztncui-controller
    volumes:
      - ztncui:/opt/key-networks/ztncui/etc/
      - zt1:/var/lib/zerotier-one/
    ports:
      - "3443:3443"
    environment:
      - MYADDR=
      - HTTP_ALL_INTERFACES=yes
      - HTTP_PORT=3443
    cap_add:
      - NET_ADMIN

volumes:
  ztncui:
  zt1:
```
- 环境变量 MYADDR 是你服务器(比如阿里云ECS)的公网IP
- HTTP_PORT 默认是 3000,这里改为3443

> 这里有个大坑: 为了安全, 该服务启动后会同时开启 http 和 https 服务, http 监听 0.0.0.0:3000, https 监听 localhost:3443, 两者什么区别一看就懂; 所以如果想http开启外网访问, 需要配置环境变量 HTTP_ALL_INTERFACES=yes
> 
```
# 启动
docker-compose up -d
# 关闭
docker-compose down
```
如果你的服务器同时作为 `moon` 和 `controller` (官方虽然不建议这么搞, 但是我们用的是docker 来运行controller, 环境隔离了, 所以可以不用理会官方), 通过 `ps -ef | grep zerotier` 可能会发现有两个 `zerotier-one` 进程, 不要大惊小怪, docker 中一个, 宿主机中一个, 两个 `zeroTier-one` 使用了不同的 `authtoken.secret` (对应json api http header: `X-ZT1-Auth`) 互不影响~

### 3.5 DNS
[github](https://github.com/uxbh/ztdns)